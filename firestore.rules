rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper function to check if user is a member of an organization
    function isOrgMember(orgId) {
      return isSignedIn()
        && (
          // User is the owner
          get(/databases/$(database)/documents/organizations/$(orgId)).data.ownerUid == request.auth.uid
          // OR user has a membership document
          || exists(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid))
        );
    }
    
    // Helper function to check if user owns the business's organization
    function isBusinessOrgMember(businessId) {
      return isSignedIn() && isOrgMember(get(/databases/$(database)/documents/businesses/$(businessId)).data.orgId);
    }
    
    // Organizations collection
    match /organizations/{orgId} {
      // Users can read/write if they are members
      allow read, write: if isOrgMember(orgId);
      
      // Members subcollection
      match /members/{userId} {
        // Users can read members if they are org members
        // Only owners/admins can write (enforced at application level)
        allow read: if isOrgMember(orgId);
        allow write: if isOrgMember(orgId);
      }
    }
    
    // Businesses collection - org-scoped access
    match /businesses/{businessId} {
      // Users can read/write businesses if they are members of the business's organization
      // Also allow server-side reads temporarily (for API routes without Admin SDK)
      allow read: if isBusinessOrgMember(businessId) || request.auth == null;
      allow write: if isBusinessOrgMember(businessId);
      
      // All subcollections inherit the same org membership check
      match /entities/{entityId} {
        allow read: if isBusinessOrgMember(businessId) || request.auth == null;
        allow write: if isBusinessOrgMember(businessId);
      }
      
      match /transactions/{transactionId} {
        allow read: if isBusinessOrgMember(businessId) || request.auth == null;
        allow write: if isBusinessOrgMember(businessId);
      }
      
      match /config/{configId} {
        allow read: if isBusinessOrgMember(businessId) || request.auth == null;
        allow write: if isBusinessOrgMember(businessId);
      }
      
      match /metricsDaily/{metricId} {
        allow read: if isBusinessOrgMember(businessId) || request.auth == null;
        allow write: if isBusinessOrgMember(businessId);
      }
      
      match /agentLogs/{logId} {
        allow read: if isBusinessOrgMember(businessId) || request.auth == null;
        allow write: if isBusinessOrgMember(businessId);
      }
    }
  }
}
